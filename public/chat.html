<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Chat Overlay</title>
  <style>
    :root {
      --bg: transparent;
      --size: 18px;
      --weight: normal;
    }

    body {
      margin: 0;
      background: var(--bg);
      font-family: Arial, Helvetica, sans-serif;
    }

    #chat {
      padding: 10px;
      font-size: var(--size);
      font-weight: var(--weight);
    }

    .msg {
      margin-bottom: 6px;
      line-height: 1.2;
    }

    .user {
      font-weight: bold;
      margin-right: 6px;
    }

    .msg-text {
      display: inline;
    }

    .badge {
      width: 24px;
      height: 24px;
      vertical-align: middle;
      margin-right: 4px;
      display: inline-block;
    }
  </style>
</head>

<body>
  <div id="chat"></div>

  <script>
    const chatDiv = document.getElementById("chat");
    const ws = new WebSocket(
      (location.protocol === "https:" ? "wss://" : "ws://") + location.host
    );

    ws.onmessage = (ev) => {
      const data = JSON.parse(ev.data);
      console.log("Mensagem WS:", data);
    };

    // badges locais
    const BADGE_ICONS = {
      broadcaster: "/badges/broadcaster.png",
      moderator: "/badges/moderator.png",
      subscriber: "/badges/subscriber.png",
      vip: "/badges/vip.png",
      "bot-badge": "/badges/bot-chat.png"
    };

    let config = {
      streamerColor: "#9146FF",
      streamerMsgColor: "#CCCCCC",
      modColor: "#00FF00",
      modMsgColor: "#CCCCCC",
      subColor: "#FFA500",
      subMsgColor: "#CCCCCC",
      userColor: "#FFFFFF",
      userMsgColor: "#CCCCCC",
      fontSize: "18px",
      fontWeight: "normal",
      background: "transparent"
    };

    function applyGlobalStyles() {
      document.documentElement.style.setProperty('--bg', config.background || "transparent");
      document.documentElement.style.setProperty('--size', config.fontSize || "18px");
      document.documentElement.style.setProperty('--weight', config.fontWeight || "normal");
    }

    ws.addEventListener('message', (ev) => {
      const data = JSON.parse(ev.data);

      if (data.type === "config") {
        config = { ...config, ...data.config };
        applyGlobalStyles();
        return;
      }

      if (data.user && data.message) {
        const role = data.role || "user";
        const nameColor = config[role + "Color"] || config.userColor;
        const msgColor = config[role + "MsgColor"] || config.userMsgColor;

        // badges HTML
        const badgesHTML = (data.badges || []).map(b => {
          const url = BADGE_ICONS[b];
          return url ? `<img src="${url}" class="badge">` : '';
        }).join("");

        const el = document.createElement("div");
        el.classList.add("msg");
        el.dataset.role = role;
        el.innerHTML = `${badgesHTML}<span class="user" style="color:${nameColor}">${escapeHtml(data.user)}:</span> <span class="msg-text" style="color:${msgColor}">${escapeHtml(data.message)}</span>`;
        chatDiv.appendChild(el);
        chatDiv.scrollTop = chatDiv.scrollHeight;
      }
    });

    function escapeHtml(str) {
      if (!str && str !== 0) return "";
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    (async () => {
      try {
        const res = await fetch('/api/config');
        if (res.ok) {
          const cfg = await res.json();
          config = { ...config, ...cfg };
          applyGlobalStyles();
        }
      } catch (e) {
        console.warn("Não foi possível buscar config inicial via HTTP:", e);
      }
    })();
  </script>
</body>

</html>